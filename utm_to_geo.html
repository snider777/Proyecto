<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Conversión UTM a Geográficas</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body, #map {
    height: 100%;
    margin: 0; padding: 0;
    width: 100%;
  }

  #map {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 0;
  }

  #inputPanel {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 8px;
    width: 300px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    font-family: sans-serif;
    z-index: 1000;
  }

  #inputPanel label {
    display: block;
    margin: 8px 0 4px;
    font-weight: bold;
    font-size: 0.9rem;
  }

  #inputPanel input, #inputPanel select, #inputPanel button {
    width: 100%;
    padding: 6px 8px;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  
  #inputPanel button {
    margin-top: 12px;
    cursor: pointer;
    background-color: #007bff;
    color: white;
    border: none;
    transition: background-color 0.3s;
  }
  #inputPanel button:hover {
    background-color: #0056b3;
  }

  /* Carteles resultado */
  #utmInfo, #geoInfo {
    position: absolute;
    background: rgba(255, 255, 255, 0.9);
    padding: 10px 15px;
    border-radius: 8px;
    font-family: sans-serif;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 1001;
    font-size: 1rem;
    pointer-events: none;
    white-space: nowrap;
  }

  #utmInfo {
    top: 20px;
    left: 20px;
  }
  
  #geoInfo {
    bottom: 20px;
    left: 20px;
  }
  
  /* Grilla fina overlay con CSS quizá para referencia (opcional) */
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Proj4js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<!-- Proj4Leaflet -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

</head>
<body>

<div id="map"></div>

<!-- Panel inputs -->
<div id="inputPanel">
  <label for="zoneInput">Zona UTM (1 - 60):</label>
  <input type="number" id="zoneInput" min="1" max="60" placeholder="Ej. 14" />

  <label for="hemisferioInput">Hemisferio:</label>
  <select id="hemisferioInput">
    <option value="N" selected>Norte</option>
    <option value="S">Sur</option>
  </select>

  <label for="eastingInput">X (Easting en metros):</label>
  <input type="number" id="eastingInput" placeholder="Ej. 500000" />

  <label for="northingInput">Y (Northing en metros):</label>
  <input type="number" id="northingInput" placeholder="Ej. 4649776" />

  <button id="convertBtn">Convertir a Geográficas</button>
</div>

<!-- Carteles resultado -->
<div id="utmInfo" style="display:none;"></div>
<div id="geoInfo" style="display:none;"></div>

<script>
  // Función para crear CRS dinámico para UTM (zona, hemisferio)
  function getCRSForZone(zone, hemi) {
    const southParam = hemi === "S" ? "+south" : "";
    const projString = `+proj=utm +zone=${zone} ${southParam} +ellps=WGS84 +units=m +no_defs`;
    return new L.Proj.CRS('EPSG:326' + (zone < 10 ? '0' + zone : zone) , projString, {
      resolutions: [
        8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1,0.5,0.25
      ],
      origin: [-20037508.342789244, 20037508.342789244]
    });
  }

  // Inicializamos mapa con CRS global WebMercator WGS84 para empezar
  let map = L.map('map', {
    center: [20, -100],
    zoom: 4
  });

  // Capa base profesional ESRI World Imagery
  let baseLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/' +
    'World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
    maxZoom: 18
  }).addTo(map);

  // Función para validar entradas
  function validateInputs(zone, hemi, x, y) {
    if (isNaN(zone) || zone<1 || zone>60) return 'Zona UTM debe estar entre 1 y 60.';
    if (hemi !== "N" && hemi !== "S") return 'Hemisferio inválido.';
    if (isNaN(x) || x < 100000 || x > 1000000) return 'X (Easting) debe estar entre 100,000 y 1,000,000 metros.';
    if (isNaN(y) || y < 0 || y > 10000000) return 'Y (Northing) inválido o fuera de rango.';
    return null;
  }

  let utmInfoDiv = document.getElementById('utmInfo');
  let geoInfoDiv = document.getElementById('geoInfo');
  let marker;

  // Evento botón convertir
  document.getElementById('convertBtn').addEventListener('click', () => {
    const zone = parseInt(document.getElementById('zoneInput').value);
    const hemi = document.getElementById('hemisferioInput').value;
    const x = parseFloat(document.getElementById('eastingInput').value);
    const y = parseFloat(document.getElementById('northingInput').value);

    const error = validateInputs(zone, hemi, x, y);
    if (error) {
      alert(error);
      return;
    }

    // Convertir UTM a LatLon con proj4js
    const projUTM = `+proj=utm +zone=${zone} ${hemi === "S" ? "+south" : ""} +ellps=WGS84 +units=m +no_defs`;
    const projWGS84 = "+proj=longlat +datum=WGS84 +no_defs";
    const [lon, lat] = proj4(projUTM, projWGS84, [x, y]);

    // Mostrar info en carteles
    utmInfoDiv.style.display = 'block';
    utmInfoDiv.innerHTML =
      `<b>Zona UTM:</b> ${zone} ${hemi} <br><b>X:</b> ${x.toFixed(2)} m | <b>Y:</b> ${y.toFixed(2)} m`;

    geoInfoDiv.style.display = 'block';
    geoInfoDiv.innerHTML =
      `<b>Latitud:</b> ${lat.toFixed(6)}° <br> <b>Longitud:</b> ${lon.toFixed(6)}°`;

    // Añadir o mover marcador
    if (marker) {
      marker.setLatLng([lat, lon]);
    } else {
      marker = L.marker([lat, lon]).addTo(map);
    }

    // Centrar mapa y ajustar zoom
    map.setView([lat, lon], 14);

    // Si quieres, aquí podrías añadir un overlay con líneas UTM para la zona, pero 
    // Leaflet no tiene grilla UTM estándar out-of-the-box. Podrías usar polilíneas o plugins.

    // Como referencia visual sencilla: 
    // Crear líneas UTM cada 10km (10000m) en entorno del marcador:
    // Para evitar sobrecarga, eliminamos previas al crear nuevas.

    if (window.utmGridGroup) {
      window.utmGridGroup.clearLayers();
    } else {
      window.utmGridGroup = L.layerGroup().addTo(map);
    }

    const gridSize = 10000; // 10km
    const range = 10; // 10 líneas a cada lado (100km)

    // Redondear X,Y a múltiplo de gridSize inferior
    const baseX = Math.floor(x / gridSize) * gridSize;
    const baseY = Math.floor(y / gridSize) * gridSize;

    for(let i = -range; i <= range; i++) {
      // Líneas verticales (Easting)
      let lineCoords = [];
      for(let j = -range; j <= range; j++){
        // Convertir UTM a latlon para cada punto
        const utmX = baseX + i * gridSize;
        const utmY = baseY + j * gridSize;
        const [lng, lat] = proj4(projUTM, projWGS84, [utmX, utmY]);
        lineCoords.push([lat, lng]);
      }
      const polyLine = L.polyline(lineCoords, {color: '#555', weight: 1, opacity: 0.3});
      window.utmGridGroup.addLayer(polyLine);
    }

    for(let j = -range; j <= range; j++) {
      // Líneas horizontales (Northing)
      let lineCoords = [];
      for(let i = -range; i <= range; i++) {
        const utmX = baseX + i * gridSize;
        const utmY = baseY + j * gridSize;
        const [lng, lat] = proj4(projUTM, projWGS84, [utmX, utmY]);
        lineCoords.push([lat, lng]);
      }
      const polyLine = L.polyline(lineCoords, {color: '#555', weight: 1, opacity: 0.3});
      window.utmGridGroup.addLayer(polyLine);
    }
  });
</script>

</body>
</html>
